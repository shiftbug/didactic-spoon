<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Character set declaration for proper text display -->
    <meta charset="UTF-8">
    <!-- Title of the web page -->
    <title>Web UI Project</title>
    <!-- Link to the external CSS file for styling -->
    <link rel="stylesheet" href="/static/style.css">
    <!-- Including jQuery library from Google CDN for AJAX and DOM manipulation -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="module" src="/src/main.jsx"></script>
</head>

<body>
    <div id="root"></div>
    <!-- Main container that wraps the entire layout -->

    <script>
        // JavaScript functions to handle AJAX calls and update the UI
        // Sync the slider and the number input
        function syncSliderAndInput(sliderId, inputId) {
            var slider = document.getElementById(sliderId);
            var input = document.getElementById(inputId);

            slider.oninput = function () {
                input.value = this.value;
            };
            input.oninput = function () {
                slider.value = this.value;
            };
        }

        // Call this function for each pair of slider and input
        syncSliderAndInput('temperature-slider', 'temperature');
        syncSliderAndInput('max_tokens-slider', 'max_tokens');
        syncSliderAndInput('top_p-slider', 'top_p');
        syncSliderAndInput('frequency_penalty-slider', 'frequency_penalty');
        syncSliderAndInput('presence_penalty-slider', 'presence_penalty');

        // Update slider values dynamically
        document.getElementById('temperature').oninput = function () {
            document.getElementById('temperature-value').textContent = this.value;
        }
        document.getElementById('max_tokens').oninput = function () {
            document.getElementById('max_tokens-value').textContent = this.value;
        }
        document.getElementById('top_p').oninput = function () {
            document.getElementById('top_p-value').textContent = this.value;
        }
        document.getElementById('frequency_penalty').oninput = function () {
            document.getElementById('frequency_penalty-value').textContent = this.value;
        }
        document.getElementById('presence_penalty').oninput = function () {
            document.getElementById('presence_penalty-value').textContent = this.value;
        }



        // Object mapping prompt IDs to their respective content strings
        var promptContents = {
            'conflicting-views': 'As a reader encountering this passage for the first time, how do you connect to the content?',
            'prompt2': 'As a distinguished author what stands out to you about this text?',
            'prompt3': 'As a social media expert, Suggest some compelling tweets related to this material.',
            'prompt4': 'As a someone who sees things differently, what might we take into account which would run contrary to our first assumption when reading this text??',

            // Add more mappings as needed
        };

        // Function to retrieve the content associated with a given prompt ID
        function getPromptContent(promptId) {
            // If the promptId exists in the mapping, return its content; otherwise, return a default string
            return promptContents[promptId] || 'Error: promptId';
        }

        // Function to load a file's content into the text area
        function loadFile(filename) {
            // Perform an AJAX POST request to the '/load_file' endpoint
            $.ajax({
                url: '/load_file',
                type: 'POST',
                data: { filename: filename }, // Data sent to the server includes the filename
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8', // Content type of the request
                success: function (response) {
                    // On success, set the content of the '#text-content' textarea to the file content
                    $('#text-content').val(response.content);
                },
                error: function (xhr, status, error) {
                    // On error, alert the user with the status and a readable error message
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }

        // Function to save the content of the text area to a file
        function saveFile() {
            // Prompt the user for a filename to save the content as
            var filename = prompt("Enter filename to save as:", "example.txt");
            // If no filename is provided, alert the user and exit the function
            if (!filename) {
                alert('Save cancelled.');
                return;
            }
            // Get the content of the '#text-content' textarea
            var content = $('#text-content').val();
            // Perform an AJAX POST request to the '/save_file' endpoint
            $.ajax({
                url: '/save_file',
                type: 'POST',
                data: { filename: filename, content: content },
                success: function (response) {
                    // If the response indicates success, alert the user
                    if (response.success) {
                        alert('File saved successfully.');
                    } else {
                        // If the response does not indicate success, alert the user of the failure
                        alert('File could not be saved.');
                    }
                },
                error: function (xhr, status, error) {
                    // On error, alert the user with a detailed error message
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }

        // Function to send the content of a simple text area to the server for processing
        function sendSimpleText() {
            // Get the content of the '#simple-text' textarea
            var content = $('#simple-text').val();
            // Perform an AJAX POST request to the '/process_text' endpoint
            $.ajax({
                url: '/process_text',
                type: 'POST',
                data: { text: content },
                success: function (response) {
                    // On success, set the text of the '#output-panel' to the processed text
                    $('#output-panel').text(response.processed_text);
                },
                error: function () {
                    // On error, alert the user
                    alert('Error processing simple text.');
                }
            });
        }

        // Function to toggle the visibility of a module in the right panel
        function toggleModule() {
            // Get the value of the '#module-select' element, which corresponds to the selected module
            var selectedModule = $('#module-select').val();
            // Logic to add or remove the module from the right panel goes here
        }

        // Event listener for file input changes
        document.getElementById('file-input').addEventListener('change', function (event) {
            // Get the file selected by the user
            var file = event.target.files[0];
            if (file) {
                // Create a FileReader to read the file
                var reader = new FileReader();
                reader.onload = function (e) {
                    // On successful file read, set the content of the '#text-content' textarea to the file's text
                    $('#text-content').val(e.target.result);
                };
                // Read the file as text
                reader.readAsText(file);
            }
        });

        function sendCompletion() {
            // Retrieve the text content from the textarea with the id 'completion-text'
            var promptTextContent = $('#completion-text').val();
            var temperature = $('#temperature').val();
            var max_tokens = $('#max_tokens').val();
            var top_p = $('#top_p').val();
            var frequency_penalty = $('#frequency_penalty').val();
            var presence_penalty = $('#presence_penalty').val();

            // Iterate over each '.module' element in the DOM
            $('.module').each(function () {
                // Cache the current module element being iterated over
                var moduleElement = $(this);

                // Check if the module's associated checkbox is checked
                var isChecked = moduleElement.find('input[type="checkbox"]').is(':checked');

                // If the checkbox is checked, proceed with sending the completion request
                if (isChecked) {
                    // Get the selected prompt ID from the module's '.prompt-select' dropdown
                    var promptId = moduleElement.find('.prompt-select').val();

                    // Retrieve the corresponding prompt content for the selected prompt ID
                    var promptContent = getPromptContent(promptId);

                    // Find the '.module-output' textarea within the current module for displaying the response
                    var moduleOutput = moduleElement.find('.module-output');

                    // Perform an AJAX POST request to the '/get_completion' endpoint
                    $.ajax({
                        url: '/get_completion',
                        type: 'POST',
                        // Send the selected prompt content and the user-entered text as data to the server
                        data: {
                            prompt: promptContent,
                            text: promptTextContent,
                            temperature: temperature,
                            max_tokens: max_tokens,
                            top_p: top_p,
                            frequency_penalty: frequency_penalty,
                            presence_penalty: presence_penalty
                        },// Set the context to the module's output textarea to use it within the success callback
                        context: moduleOutput,
                        success: function (response) {
                            // On success, set the value of the module's output textarea to the response's completion data
                            this.val(response.completion);
                        },
                        error: function (xhr, status, error) {
                            // Log detailed error information to the console
                            console.error('AJAX Error:', xhr, status, error);
                            // Alert the user that there was an error getting the completion
                            alert('Error getting completion.');
                        }
                    });
                }
            });
        }

        // Event listener for clicks on list items within the '#recent-files' list
        $('#recent-files li').click(function () {
            // Retrieve the text of the clicked list item, which is the filename
            var filename = $(this).text();
            // Call the loadFile function, passing the filename to load its content
            loadFile(filename);
        });

        // When the document is ready (all DOM elements are loaded and accessible)
        $(document).ready(function () {
            // Perform an AJAX GET request to the '/list_recent_files' endpoint
            $.ajax({
                url: '/list_recent_files',
                type: 'GET',
                success: function (response) {
                    // Select the unordered list within the '.recent-docs' div to populate with file names
                    var fileList = $('.recent-docs ul');
                    // Clear any existing list items
                    fileList.empty();
                    // Check if the response contains files and that there's at least one file
                    if (response.files && response.files.length > 0) {
                        // Iterate over each file received in the response
                        response.files.forEach(function (file) {
                            // Create a new list item for each file with the file name as text
                            var listItem = $('<li>').text(file).click(function () {
                                // Add a click event listener to each list item to load the file when clicked
                                loadFile(file);
                            });
                            // Append the new list item to the file list in the UI
                            fileList.append(listItem);
                        });
                    } else {
                        // If there are no recent files, append a list item indicating this to the user
                        fileList.append($('<li>').text('No recent documents').addClass('no-files'));
                    }
                },
                error: function () {
                    // If there's an error fetching the recent files, alert the user
                    alert('Error fetching recent files.');
                }
            });
        });
    </script>