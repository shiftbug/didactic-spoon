<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web UI Project</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="menu">
                <h2>Menu Items</h2>
                <ul id="recent-files">
                    <!-- Recent files will be loaded here by JavaScript -->
                </ul>
            </div>
            <div class="recent-docs">
                <h2>Recent Docs</h2>
                <ul>
                    <!-- List of recent documents -->
                </ul>
            </div>
        </aside>
        <main class="main-content">
            <div class="settings-panel">
                <!-- Settings Panel -->
                <input type="file" id="file-input" accept=".txt" />
                <button onclick="saveFile()">Save</button>
            </div>
            <textarea id="text-content" name="text-content" rows="10" cols="50">Edit text here...</textarea>
            <div class="form-controls">
                <button type="button" onclick="sendText()">Send</button>
            </div>
            <!-- Special Text Entry for OpenAI Completions -->
            <div class="text-entry">
                <textarea id="completion-text" rows="4" cols="50">Enter prompt here...</textarea>
                <button type="button" onclick="sendCompletion()">Send</button>
            </div>
        </main>
        <!-- Right Panel Dropdown and Modules -->
        <aside class="sidebar">
            <div class="dropdown">
                <select id="module-select" onchange="toggleModule()">
                    <option value="">Select a Module...</option>
                    <option value="readers-expectations">Reader's Expectations</option>
                    <option value="authors-insights">Author's Insights</option>
                    <!-- Add more module options here -->
                </select>
            </div>
            <div id="modules-container">
                <!-- Modules will be dynamically added here -->
            </div>
        </aside>
    </div>

    <script>
        // JavaScript functions to handle AJAX calls and update the UI
    
        function loadFile(filename) {
            $.ajax({
                url: '/load_file',
                type: 'POST',
                data: { filename: filename }, // Ensure this data includes the 'filename' key
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8', // Make sure to set the correct content type
                success: function(response) {
                    $('#text-content').val(response.content);
                },
                error: function(xhr, status, error) {
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }
    
        function saveFile() {
            var filename = prompt("Enter filename to save as:", "example.txt"); // Prompt user for filename
            if (!filename) {
                alert('Save cancelled.'); // Notify user that save is cancelled if no filename is provided
                return; // Exit if no filename is provided
            }
            var content = $('#text-content').val();
            $.ajax({
                url: '/save_file',
                type: 'POST',
                data: { filename: filename, content: content },
                success: function(response) {
                    if(response.success) {
                        alert('File saved successfully.');
                    } else {
                        // Handle the case where 'success' is not true
                        alert('File could not be saved.');
                    }
                },
                error: function(xhr, status, error) {
                    // Provide more detailed feedback to the user
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }
    
        function sendSimpleText() {
            var content = $('#simple-text').val();
            $.ajax({
                url: '/process_text',
                type: 'POST',
                data: { text: content },
                success: function(response) {
                    $('#output-panel').text(response.processed_text);
                },
                error: function() {
                    alert('Error processing simple text.');
                }
            });
        }
    
                function toggleModule() {
            var selectedModule = $('#module-select').val();
            // Logic to add or remove the module from the right panel
        }

        document.getElementById('file-input').addEventListener('change', function(event) {
            var file = event.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#text-content').val(e.target.result);
                };
                reader.readAsText(file);
            }
        });

        function sendCompletion() {
            var activeModules = [];
            // Find all active modules based on checkboxes
            $('#modules-container .module').each(function() {
                if ($(this).find('input[type="checkbox"]').is(':checked')) {
                    activeModules.push($(this).attr('id')); // Assuming each module has a unique ID
                }
            });

            var prompts = activeModules.map(function(moduleId) {
                return $('#' + moduleId + ' .prompt').val(); // Assuming each module has a textarea with class 'prompt'
            });

            // Combine prompts and send to OpenAI API
            var combinedPrompt = prompts.join('\n');
            // AJAX call to your Flask backend, which will then call the OpenAI API
        }
    
        $('#recent-files li').click(function() {
            var filename = $(this).text(); // Get the filename from the list item's text
            loadFile(filename); // Pass the filename to the loadFile function
        });

        $(document).ready(function() {
            $.ajax({
                url: '/list_recent_files',
                type: 'GET',
                success: function(response) {
                    var fileList = $('#recent-docs ul'); // Update this selector to target the correct list
                    fileList.empty();
                    if (response.files && response.files.length > 0) {
                        response.files.forEach(function(file) {
                            var listItem = $('<li>').text(file).click(function() {
                                loadFile(file);
                            });
                            fileList.append(listItem);
                        });
                    } else {
                        fileList.append($('<li>').text('No recent documents').addClass('no-files'));
                    }
                },
                error: function() {
                    alert('Error fetching recent files.');
                }
            });
        });
    </script>
</body>
</html>