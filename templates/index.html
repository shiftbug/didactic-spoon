<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web UI Project</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <div class="container">
        <aside class="sidebar">
            <div class="menu">
                <h2>Menu Items</h2>
                <ul id="recent-files">
                    <!-- Recent files will be loaded here by JavaScript -->
                </ul>
            </div>
            <div class="recent-docs">
                <h2>Recent Docs</h2>
                <ul>
                    <!-- List of recent documents -->
                </ul>
            </div>
        </aside>
        <main class="main-content">
            <div class="settings-panel">
                <!-- Settings Panel -->
                <input type="file" id="file-input" accept=".txt" />
                <button onclick="saveFile()">Save</button>
            </div>
            <textarea id="text-content" name="text-content" rows="10" cols="50">Edit text here...</textarea>
            <!-- Special Text Entry for OpenAI Completions -->
            <div class="text-entry">
                <textarea id="completion-text" rows="4" cols="50">Enter prompt here...</textarea>
                <button type="button" onclick="sendCompletion()">Send</button>
            </div>
        </main>
        <!-- Right Panel Dropdown and Modules -->
        <aside class="sidebar">
            <!-- Repeat this block for each module you want to include -->
            <div class="module">
                <div class="module-header">
                    <h3>Module One</h3>
                    <select class="prompt-select">
                        <option value="prompt1">Prompt 1</option>
                        <option value="prompt2">Prompt 2</option>
                        <!-- Add more prompt options here -->
                    </select>
                </div>
                <textarea class="module-output" rows="4" cols="50" readonly></textarea>
                <label class="toggle-module">
                    <input type="checkbox" class="module-checkbox"> Activate
                </label>
            </div>
            <div class="module">
                <div class="module-header">
                    <h3>Module Two</h3>
                    <select class="prompt-select">
                        <option value="prompt1">Prompt 1</option>
                        <option value="prompt2">Prompt 2</option>
                        <!-- Add more prompt options here -->
                    </select>
                </div>
                <textarea class="module-output" rows="4" cols="50" readonly></textarea>
                <label class="toggle-module">
                    <input type="checkbox" class="module-checkbox"> Activate
                </label>
            </div>
            <!-- Add more modules as needed -->
        </aside>
    </div>

    <script>
        // JavaScript functions to handle AJAX calls and update the UI
        var promptContents = {
            'prompt1': 'Eat my shorts',
            'prompt2': 'Jagged bloody javascript',
        // Add more mappings as needed
        };    

        function getPromptContent(promptId) {
        // Retrieve the prompt content from the mapping
            return promptContents[promptId] || 'Default prompt content if not found.';
        }

        function loadFile(filename) {
            $.ajax({
                url: '/load_file',
                type: 'POST',
                data: { filename: filename }, // Ensure this data includes the 'filename' key
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8', // Make sure to set the correct content type
                success: function(response) {
                    $('#text-content').val(response.content);
                },
                error: function(xhr, status, error) {
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }
    
        function saveFile() {
            var filename = prompt("Enter filename to save as:", "example.txt"); // Prompt user for filename
            if (!filename) {
                alert('Save cancelled.'); // Notify user that save is cancelled if no filename is provided
                return; // Exit if no filename is provided
            }
            var content = $('#text-content').val();
            $.ajax({
                url: '/save_file',
                type: 'POST',
                data: { filename: filename, content: content },
                success: function(response) {
                    if(response.success) {
                        alert('File saved successfully.');
                    } else {
                        // Handle the case where 'success' is not true
                        alert('File could not be saved.');
                    }
                },
                error: function(xhr, status, error) {
                    // Provide more detailed feedback to the user
                    var errorMessage = xhr.status + ': ' + xhr.statusText;
                    alert('Error - ' + errorMessage);
                }
            });
        }
    
        function sendSimpleText() {
            var content = $('#simple-text').val();
            $.ajax({
                url: '/process_text',
                type: 'POST',
                data: { text: content },
                success: function(response) {
                    $('#output-panel').text(response.processed_text);
                },
                error: function() {
                    alert('Error processing simple text.');
                }
            });
        }
    
                function toggleModule() {
            var selectedModule = $('#module-select').val();
            // Logic to add or remove the module from the right panel
        }

        document.getElementById('file-input').addEventListener('change', function(event) {
            var file = event.target.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#text-content').val(e.target.result);
                };
                reader.readAsText(file);
            }
        });

        function sendCompletion() {
            var promptTextContent = $('#completion-text').val(); // Use the content from the "Enter prompt here..." textarea
            $('.module').each(function() {
                var moduleElement = $(this);
                var isChecked = moduleElement.find('input[type="checkbox"]').is(':checked');
                if (isChecked) {
                    var promptId = moduleElement.find('.prompt-select').val();
                    var promptContent = getPromptContent(promptId);
                    var moduleOutput = moduleElement.find('.module-output');
                    $.ajax({
                        url: '/get_completion',
                        type: 'POST',
                        data: { prompt: promptContent, text: promptTextContent }, // Send the correct text content
                        context: moduleOutput,
                        success: function(response) {
                            this.val(response.completion); // Set the value of the module's output textarea
                        },
                        error: function(xhr, status, error) {
                            console.error('AJAX Error:', xhr, status, error); // Log detailed error information
                            alert('Error getting completion.');
                        }
                    });
                }
            });
        }
    
        $('#recent-files li').click(function() {
            var filename = $(this).text(); // Get the filename from the list item's text
            loadFile(filename); // Pass the filename to the loadFile function
        });

        $(document).ready(function() {
            $.ajax({
                url: '/list_recent_files',
                type: 'GET',
                success: function(response) {
                    var fileList = $('#recent-docs ul'); // Update this selector to target the correct list
                    fileList.empty();
                    if (response.files && response.files.length > 0) {
                        response.files.forEach(function(file) {
                            var listItem = $('<li>').text(file).click(function() {
                                loadFile(file);
                            });
                            fileList.append(listItem);
                        });
                    } else {
                        fileList.append($('<li>').text('No recent documents').addClass('no-files'));
                    }
                },
                error: function() {
                    alert('Error fetching recent files.');
                }
            });
        });
    </script>
</body>
</html>